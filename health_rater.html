<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TATIL COVERCARE Premium Rater & Referral Hub</title>

    <!-- PWA Manifest & Meta Tags -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#005f73">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="TATIL Raters">
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/005f73/FFFFFF?text=TATIL">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&family=Source+Serif+Pro:wght@600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-main: #f4f6f9; 
            --bg-bento-box: #ffffff;
            --text-primary: #1d2d35; 
            --text-secondary: #4a5568; 
            --text-muted: #718096;    
            --border-color: #dce1e7; 
            --primary-accent: #005f73; 
            --primary-accent-darker: #003d4d;
            --secondary-accent: #ae8625; 
            --secondary-accent-darker: #8c6c1d;
            --shadow-soft: 0 3px 6px rgba(0,0,0,0.04);
            --shadow-medium: 0 5px 15px rgba(0,0,0,0.06);
            --shadow-strong: 0 8px 25px rgba(0,0,0,0.08);
            --font-body: 'Montserrat', sans-serif;
            --font-heading: 'Source Serif Pro', serif; 
        }

        .dark-mode {
            --bg-main: #1f2937; 
            --bg-bento-box: #2b3c4d; 
            --text-primary: #f0f4f8; 
            --text-secondary: #d1d5db; 
            --text-muted: #9ca3af;    
            --border-color: #4b5f71; 
            --primary-accent: #25a1af; 
            --primary-accent-darker: #1e838f;
            --secondary-accent: #daa520; 
            --secondary-accent-darker: #b8860b;
        }

        body {
            font-family: var(--font-body);
            background-color: var(--bg-main);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        h1, h2, h3, h4 { font-family: var(--font-heading); color: var(--primary-accent); }
        .bento-box {
            background-color: var(--bg-bento-box);
            border-radius: 0.75rem; 
            padding: 1.75rem; 
            box-shadow: var(--shadow-medium);
            transition: background-color 0.3s ease, box-shadow 0.3s ease, transform 0.2s ease;
            border: 1px solid var(--border-color);
        }
        .bento-box:hover { transform: translateY(-5px); box-shadow: var(--shadow-strong); }

        input, select {
            border: 1px solid var(--border-color); padding: 0.85rem 1.15rem; border-radius: 0.375rem; 
            transition: border-color 0.2s ease, box-shadow 0.2s ease, background-color 0.3s ease, color 0.3s ease;
            background-color: var(--bg-main); color: var(--text-primary);
            font-weight: 500;
        }
        input:focus, select:focus {
            border-color: var(--primary-accent); box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary-accent) 25%, transparent); 
            outline: none; background-color: var(--bg-bento-box);
        }
        
        .button-base {
            font-weight: 600; padding-top: 0.85rem; padding-bottom: 0.85rem; border-radius: 0.375rem;
            transition: background-color 0.2s ease, transform 0.15s ease, box-shadow 0.2s ease;
            box-shadow: var(--shadow-soft); text-transform: uppercase; letter-spacing: 0.025em;
            cursor: pointer;
        }
        .button-base:hover { transform: translateY(-2px); box-shadow: var(--shadow-medium); }
        
        .primary-btn { background-color: var(--primary-accent); color: white; }
        .primary-btn:hover { background-color: var(--primary-accent-darker); }
        .dark-mode .primary-btn { color: var(--text-primary); }

        .secondary-btn { background-color: var(--secondary-accent); color: white; }
        .secondary-btn:hover { background-color: var(--secondary-accent-darker); }
        .dark-mode .secondary-btn { color: var(--text-primary); }

        
        /* Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(29, 45, 53, 0.7);
            display: flex; align-items: center; justify-content: center; z-index: 50;
            backdrop-filter: blur(5px);
        }
        .modal-content {
            background-color: var(--bg-bento-box); margin: auto; padding: 2rem; border: 1px solid var(--border-color);
            width: 90%; 
            border-radius: 0.75rem; position: relative;
            box-shadow: var(--shadow-strong);
        }
        
        /* Toggle Switch */
        .theme-switch-wrapper { display: flex; align-items: center; background-color: var(--bg-bento-box); padding: 0.5rem 0.75rem; border-radius: 999px; box-shadow: var(--shadow-medium); border: 1px solid var(--border-color); }
        .theme-switch { position: relative; display: inline-block; width: 40px; height: 20px; } 
        .theme-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 20px; }
        .dark-mode .slider { background-color: var(--primary-accent); }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider:before { transform: translateX(20px); } 

        /* Floating WhatsApp Button */
        .whatsapp-float {
            position: fixed; width: 60px; height: 60px; bottom: 40px; right: 40px; background-color: #25d366; color: #FFF; border-radius: 50px;
            text-align: center; font-size: 30px; box-shadow: 2px 2px 6px rgba(0,0,0,0.25); z-index: 100;
            display: flex; align-items: center; justify-content: center; transition: transform 0.2s ease;
        }
        .whatsapp-float:hover { transform: scale(1.1); }
        .breakdown-row { display: flex; justify-content: space-between; flex-wrap: wrap; }
        .loader {
            width: 48px; height: 48px; border: 5px solid var(--primary-accent);
            border-bottom-color: transparent; border-radius: 50%;
            display: inline-block; box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="min-h-screen p-4 md:p-6 lg:p-8">

    <div class="fixed top-4 right-4 z-[101] flex items-center space-x-4">
        <a href="./index.html" class="text-sm font-semibold text-[var(--primary-accent)] hover:underline">&larr; Back to Hub</a>
        <div class="theme-switch-wrapper">
            <span class="mr-2 text-xs font-semibold" id="themeToggleLabel">LIGHT</span>
            <label class="theme-switch" for="themeToggleCheckbox">
                <input type="checkbox" id="themeToggleCheckbox" />
                <div class="slider round"></div>
            </label>
        </div>
    </div>

    <div id="auth-loader" class="text-center p-20">
        <div class="loader mx-auto"></div>
        <p class="mt-4 text-[var(--text-secondary)]">Authenticating...</p>
    </div>

    <div id="health-rater-app" class="w-full max-w-6xl mx-auto my-8 hidden">
        <header class="mb-10 text-center">
            <h1 id="main-header" class="text-4xl sm:text-5xl font-bold mb-3">TATIL COVERCARE Premium Rater</h1>
            <p class="text-xl text-[var(--text-secondary)]">Health Insurance Plans, Simplified.</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Column: Inputs -->
            <div class="lg:col-span-2 space-y-8">
                <!-- Step 1: Plan Selection -->
                <div class="bento-box">
                    <h2 class="text-2xl font-bold mb-4"><i class="fas fa-users mr-3 text-[var(--secondary-accent)]"></i>Select Insured Details</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="family-status" class="block text-sm font-medium text-[var(--text-muted)]">Family Status</label>
                            <select id="family-status" class="mt-1 w-full p-2.5"></select>
                        </div>
                        <div>
                            <label for="age-band" class="block text-sm font-medium text-[var(--text-muted)]">Age Band</label>
                            <select id="age-band" class="mt-1 w-full p-2.5"></select>
                        </div>
                        <div>
                            <label for="children-count" class="block text-sm font-medium text-[var(--text-muted)]">Number of Children</label>
                            <select id="children-count" class="mt-1 w-full p-2.5"></select>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Plan Options -->
                <div class="bento-box">
                    <h2 class="text-2xl font-bold mb-4"><i class="fas fa-clipboard-list mr-3 text-[var(--secondary-accent)]"></i>Select Plan Options</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="plan-type" class="block text-sm font-medium text-[var(--text-muted)]">Plan Type</label>
                             <select id="plan-type" class="mt-1 w-full p-2.5"></select>
                        </div>
                        <div>
                            <label for="payment-frequency" class="block text-sm font-medium text-[var(--text-muted)]">Payment Frequency</label>
                            <select id="payment-frequency" class="mt-1 w-full p-2.5"></select>
                        </div>
                        <div id="base-plan-options" class="contents">
                            <div>
                                <label for="dental-vision" class="block text-sm font-medium text-[var(--text-muted)]">Add Dental & Vision</label>
                                <select id="dental-vision" class="mt-1 w-full p-2.5"></select>
                            </div>
                            <div id="maternity-container">
                                <label for="maternity" class="block text-sm font-medium text-[var(--text-muted)]">Maternity Coverage</label>
                                 <select id="maternity" class="mt-1 w-full p-2.5"></select>
                            </div>
                        </div>
                         <div id="major-medical-options" class="contents">
                             <div>
                                <label for="major-medical-amount" class="block text-sm font-medium text-[var(--text-muted)]">Major Medical Coverage</label>
                                <select id="major-medical-amount" class="mt-1 w-full p-2.5"></select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Right Column: Results -->
            <div class="lg:col-span-1 space-y-8">
                 <div id="results-section" class="bento-box sticky top-8 text-center">
                    <h2 class="text-2xl font-bold mb-2"><i class="fas fa-receipt mr-3 text-[var(--secondary-accent)]"></i>Premium Summary</h2>
                    <p id="total-premium" class="text-4xl font-bold text-[var(--primary-accent)] mt-4">$0.00</p>
                    <p id="total-premium-label" class="text-sm text-[var(--text-muted)]">(Total Annual Premium)</p>
                    <div id="premium-breakdown" class="text-left mt-6 pt-4 border-t border-[var(--border-color)] text-[var(--text-secondary)] text-sm space-y-1"></div>
                     <div id="frequency-comparison" class="text-left mt-6 pt-4 border-t border-[var(--border-color)] text-[var(--text-secondary)] text-sm space-y-2"></div>
                    <div id="finders-fee-section" class="text-left mt-6 pt-4 border-t-2 border-dashed border-[var(--secondary-accent)] hidden">
                        <h3 class="text-lg font-bold text-[var(--primary-accent)] mb-2">Initial Finder's Fee</h3>
                        <div id="finders-fee-breakdown" class="text-[var(--text-secondary)] text-sm space-y-1"></div>
                    </div>
                    <div class="mt-6">
                        <button id="proceed-to-quote-btn" class="w-full primary-btn button-base py-3">
                            Create Referral & Quote
                        </button>
                    </div>
                </div>
            </div>
        </main>

        <footer class="text-center mt-12 text-xs text-[var(--text-muted)]">
            <p>&copy; <span id="currentYear"></span> TATIL. Your Future, Secured.</p>
        </footer>
    </div>

    <!-- Combined Quote & Referral Modal -->
    <div id="quote-referral-modal" class="modal-overlay hidden">
        <div class="modal-content max-w-4xl">
            <h3 id="modal-header" class="text-2xl font-bold leading-6 mb-6 text-center">Referral & Official Quotation</h3>

            <div class="grid md:grid-cols-2 gap-8">
                <!-- Left side: Client Info for Referral -->
                <div>
                    <h4 class="text-lg font-bold mb-4 text-[var(--primary-accent)]">Step 1: Enter Client Information</h4>
                    <div class="space-y-4">
                        <input type="text" id="client-name" placeholder="Client's Full Name" class="w-full" required>
                        <input type="email" id="client-email" placeholder="Client's Email Address" class="w-full" required>
                        <input type="text" id="client-contact" placeholder="Client's Contact Number" class="w-full" required>
                    </div>
                    <p id="client-modal-error" class="text-red-500 text-sm text-center mt-4 h-4"></p>
                </div>

                <!-- Right side: Quote Preview -->
                <div>
                    <h4 class="text-lg font-bold mb-4 text-[var(--primary-accent)]">Step 2: Review Official Quote</h4>
                    <div id="quote-output-container" class="w-full h-64 overflow-y-auto bg-[var(--bg-main)] p-4 border border-[var(--border-color)] rounded-md">
                        <pre id="quote-output" class="whitespace-pre-wrap text-sm font-mono"></pre>
                    </div>
                </div>
            </div>
            
            <div class="flex items-center space-x-3 mt-4 pt-4 border-t border-[var(--border-color)]">
                <input type="checkbox" id="waive-fee-checkbox" class="h-4 w-4">
                <label for="waive-fee-checkbox" class="text-sm font-medium text-[var(--text-secondary)]">Waive finder's fee for this referral</label>
            </div>

            <!-- Action Buttons -->
            <div class="mt-8 pt-6 border-t border-[var(--border-color)] flex flex-wrap justify-between items-center gap-4">
                <div>
                    <button id="close-modal-btn" type="button" class="button-base bg-gray-200 text-gray-700 dark:bg-gray-700 dark:text-gray-200 py-2 px-4">Cancel</button>
                </div>
                <div class="flex flex-wrap gap-3">
                    <button id="copy-quote-btn" type="button" class="button-base secondary-btn py-2 px-4">Copy Quote</button>
                    <button id="download-pdf-btn" type="button" class="button-base secondary-btn py-2 px-4">Download PDF</button>
                    <button id="submit-referral-btn" type="button" class="button-base primary-btn py-2 px-4">Submit Referral</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="success-modal" class="modal-overlay hidden">
        <div class="modal-content text-center">
            <i class="fas fa-check-circle text-5xl text-green-500 mx-auto mb-4"></i>
            <h3 id="success-header" class="text-xl font-bold leading-6 mb-2">Referral Submitted!</h3>
            <p class="text-[var(--text-secondary)]">You can track its status on your dashboard.</p>
            <div class="mt-6">
                 <a href="./index.html" class="button-base primary-btn py-2 px-4">Back to Dashboard</a>
            </div>
        </div>
    </div>
    
    <!-- WhatsApp Floating Button -->
    <a href="https://wa.me/18687981014" class="whatsapp-float" target="_blank" rel="noopener noreferrer">
        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" class="bi bi-whatsapp" viewBox="0 0 16 16">
            <path d="M13.601 2.326A7.854 7.854 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.933 7.933 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.898 7.898 0 0 0 13.6 2.326zM7.994 14.521a6.573 6.573 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.557 6.557 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592zm3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.1-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.729.729 0 0 0-.529.247c-.182.198-.691.677-.691 1.654 0 .977.71 1.916.81 2.049.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943s-.182-.133-.38-.232z"/>
        </svg>
    </a>
    
    <script src="health_rater_data.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, addDoc, updateDoc, Timestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        // These will be replaced by global variables in the final environment
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "AIza...", authDomain: "...", projectId: "..." };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        setLogLevel('debug'); // Optional: for detailed Firestore logs

        // --- Global State ---
        let currentUserData = null;
        let lastCalculatedData = {};
        let fullQuoteText = '';
        let editMode = false;
        let referralIdToEdit = null;

        // --- DOM ELEMENTS ---
        const getElement = (id) => document.getElementById(id);

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof RATES === 'undefined' || !RATES.vision_dental) {
                document.body.innerHTML = '<div class="text-red-500 text-center p-8">Error: Could not load rate data. Please ensure health_rater_data.js is present and correct.</div>';
                return;
            }

            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('edit')) {
                editMode = true;
                referralIdToEdit = urlParams.get('edit');
            }
            
            setupTheme();
            getElement('currentYear').textContent = new Date().getFullYear();

            onAuthStateChanged(auth, async (user) => {
                const appEl = getElement('health-rater-app');
                const loaderEl = getElement('auth-loader');
                if (user) {
                    const userDoc = await getDoc(doc(db, "users", user.uid));
                    currentUserData = userDoc.exists() ? { uid: user.uid, ...userDoc.data() } : null;
                    
                    if (!currentUserData) {
                         loaderEl.innerHTML = `<div class="text-center bento-box max-w-lg mx-auto"><h3 class="text-xl font-bold leading-6 mb-2">User Not Found</h3><p class="text-[var(--text-secondary)]">Your user profile could not be loaded.</p></div>`;
                        return;
                    }

                    appEl.classList.remove('hidden');
                    loaderEl.classList.add('hidden');
                    if (editMode && referralIdToEdit) {
                        await initializeRaterForEdit();
                    } else {
                        initializeRater();
                    }
                } else {
                    // Sign in if token is available, otherwise show login prompt
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                         try {
                            await signInWithCustomToken(auth, __initial_auth_token);
                         } catch (error) {
                             console.error("Custom token sign-in failed:", error);
                             await signInAnonymously(auth); // Fallback
                         }
                    } else {
                        // Fallback for local testing or if token isn't provided
                        try {
                           await signInAnonymously(auth);
                           console.log("Signed in anonymously for local testing.");
                        } catch(error) {
                           loaderEl.innerHTML = `<div class="text-center bento-box max-w-lg mx-auto"><h3 class="text-xl font-bold leading-6 mb-2">Authentication Error</h3><p class="text-[var(--text-secondary)]">You must be logged in to use the rater.</p><div class="mt-6"><a href="./index.html" class="button-base primary-btn py-2 px-4">Go to Login</a></div></div>`;
                           appEl.classList.add('hidden');
                           loaderEl.classList.remove('hidden');
                        }
                    }
                }
            });
        });
        
        function initializeRater() {
            if(editMode){
                getElement('main-header').textContent = "Edit Health Referral";
                getElement('proceed-to-quote-btn').textContent = "Update Referral & Quote";
                getElement('modal-header').textContent = "Update Referral & Official Quotation";
                getElement('submit-referral-btn').textContent = "Update Referral";
                getElement('success-header').textContent = "Referral Updated!";
            }
            populateDropdowns();
            setupEventListeners();
            calculateAndDisplay();
        }

        async function initializeRaterForEdit() {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const referralRef = doc(db, "artifacts", appId, "public/data/referrals", referralIdToEdit);
            const referralDoc = await getDoc(referralRef);

            if (referralDoc.exists()) {
                const data = referralDoc.data();
                // Security check: ensure the current user is the one who created the referral
                if(data.referrerId !== auth.currentUser.uid) {
                    document.body.innerHTML = `<div class="text-red-500 text-center p-8">Error: You do not have permission to edit this referral.</div>`;
                    return;
                }
                initializeRater(); // Sets up dropdowns, listeners etc.
                populateFormWithData(data); // Populates the form with existing data
            } else {
                 document.body.innerHTML = `<div class="text-red-500 text-center p-8">Error: Referral not found.</div>`;
            }
        }
        
        function populateFormWithData(data) {
             const getSelectedText = (el) => el.options[el.selectedIndex].text;
            
            // This function maps the stored text value from the DB back to the correct <option value="...">
            const setValueFromText = (selectId, textValue) => {
                const selectEl = getElement(selectId);
                for(let i=0; i<selectEl.options.length; i++) {
                    if(selectEl.options[i].text === textValue) {
                        selectEl.value = selectEl.options[i].value;
                        return;
                    }
                }
            };
            
            setValueFromText('family-status', data.familyStatusText);
            setValueFromText('age-band', data.ageBand);
            setValueFromText('children-count', data.childrenCountText);
            setValueFromText('plan-type', data.planType);
            setValueFromText('payment-frequency', data.premiumFrequency);
            getElement('dental-vision').value = data.dentalVisionAdded ? 'yes' : 'no';
            if(getElement('maternity')) {
                 setValueFromText('maternity', data.maternity);
            }
            if(getElement('major-medical-amount')) {
                 setValueFromText('major-medical-amount', data.mmAmount);
            }
            
            if(data.clientName) getElement('client-name').value = data.clientName;
            if(data.clientEmail) getElement('client-email').value = data.clientEmail;
            if(data.clientContact) getElement('client-contact').value = data.clientContact;
            getElement('waive-fee-checkbox').checked = data.feeWaived || false;

            // Recalculate everything with the loaded data
            calculateAndDisplay();
        }


        function populateDropdowns() {
            const options = {
                'family-status': {'Single Male': 'single_male', 'Single Female': 'single_female', 'Husband & Wife': 'husband_wife'},
                'age-band': {'Under 40': 'under_40', '40-49': '40_49', '50-59': '50_59', '60-65': '60_65', '66-67': '66_67', '68-70': '68_70'},
                'children-count': {'0 Children': '0', '1 Child': '1', '2 or More Children': '2+'},
                'plan-type': {'Base Plan + Major Medical': 'base_and_mm', 'COVERCARE Base Plan Only': 'base_only', 'Major Medical Only': 'mm_only'},
                'payment-frequency': {'Annual': 'annual', 'Semi-Annual': 'semi', 'Quarterly': 'quarterly'},
                'dental-vision': {'No': 'no', 'Yes': 'yes'},
                'maternity': {'No': 'no', 'Yes': 'yes'},
                'major-medical-amount': {'$50,000': '50000', '$100,000': '100000', '$200,000': '200000', '$300,000': '300000', '$500,000': '500000'}
            };
            for(const id in options) {
                const select = getElement(id);
                if (select) {
                   select.innerHTML = Object.entries(options[id]).map(([text, value]) => `<option value="${value}">${text}</option>`).join('');
                }
            }
        }
        
        function setupEventListeners() {
            document.querySelectorAll('#health-rater-app select').forEach(input => input.addEventListener('change', calculateAndDisplay));
            getElement('proceed-to-quote-btn').addEventListener('click', () => {
                if (lastCalculatedData.totalPremium > 0) {
                    getElement('waive-fee-checkbox').checked = currentUserData.waivesAllFees || false;
                    generateFinalQuoteText();
                    getElement('quote-referral-modal').style.display = 'flex';
                } else { 
                    // Use a more modern notification instead of alert
                    const btn = getElement('proceed-to-quote-btn');
                    const originalText = btn.textContent;
                    btn.textContent = "Please select options first!";
                    btn.classList.add('bg-red-500', 'hover:bg-red-600');
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.classList.remove('bg-red-500', 'hover:bg-red-600');
                    }, 2500);
                }
            });
            getElement('close-modal-btn').addEventListener('click', () => getElement('quote-referral-modal').style.display = 'none');
            getElement('copy-quote-btn').addEventListener('click', () => {
                const textToCopy = getElement('quote-output').innerText;
                const copyBtn = getElement('copy-quote-btn');
                try {
                     navigator.clipboard.writeText(textToCopy).then(() => {
                        copyBtn.textContent = 'Copied!';
                        setTimeout(() => { copyBtn.textContent = 'Copy Quote'; }, 2000);
                    });
                } catch(e) {
                     // Fallback for older browsers
                    const textArea = document.createElement("textarea");
                    textArea.value = textToCopy;
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    try {
                        document.execCommand('copy');
                        copyBtn.textContent = 'Copied!';
                        setTimeout(() => { copyBtn.textContent = 'Copy Quote'; }, 2000);
                    } catch (err) {
                       copyBtn.textContent = 'Failed!';
                    }
                    document.body.removeChild(textArea);
                }
            });
            getElement('download-pdf-btn').addEventListener('click', generateAndDownloadPDF);
            getElement('submit-referral-btn').addEventListener('click', submitReferral);
        }

        function setupTheme() {
            const themeToggle = getElement('themeToggleCheckbox');
            const themeToggleLabel = getElement('themeToggleLabel');
            function applyTheme(isDark) {
                document.documentElement.classList.toggle('dark-mode', isDark);
                document.body.classList.toggle('dark-mode', isDark);
                if(themeToggleLabel) themeToggleLabel.textContent = isDark ? 'DARK' : 'LIGHT';
                if(themeToggle) themeToggle.checked = isDark;
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
            }
            themeToggle.addEventListener('change', () => applyTheme(themeToggle.checked));
            const savedTheme = localStorage.getItem('theme');
            applyTheme(savedTheme === 'dark' || (savedTheme === null && window.matchMedia('(prefers-color-scheme: dark)').matches));
        }

        function formatCurrency(value) { return (typeof value !== 'number' || isNaN(value)) ? 'N/A' : value.toLocaleString('en-US', { style: 'currency', currency: 'USD' }); }
        
        function handleUIChanges() {
            const planType = getElement('plan-type').value;
            const familyStatus = getElement('family-status').value;
            const ageBand = getElement('age-band').value;
            
            getElement('base-plan-options').style.display = (planType === 'mm_only') ? 'none' : 'contents';
            getElement('major-medical-options').style.display = (planType === 'base_only') ? 'none' : 'contents';
            
            const maternityContainer = getElement('maternity-container');
            const maternitySelect = getElement('maternity');
            if ((familyStatus === 'single_female' || familyStatus === 'husband_wife') && planType !== 'mm_only') {
                maternityContainer.style.display = 'block';
                const isMaternityEligible = !['50_59', '60_65', '66_67', '68_70'].includes(ageBand);
                maternitySelect.disabled = !isMaternityEligible;
                if(!isMaternityEligible) maternitySelect.value = 'no';
            } else {
                maternityContainer.style.display = 'none';
                maternitySelect.value = 'no';
            }
        }

        // --- CALCULATION ENGINE (Updated) ---
        function calculateAndDisplay() {
            handleUIChanges();
            const planType = getElement('plan-type').value;
            const familyStatus = getElement('family-status').value;
            const ageBand = getElement('age-band').value;
            const childrenCount = getElement('children-count').value;
            const maternitySelect = getElement('maternity');
            const maternity = maternitySelect.disabled ? 'no' : maternitySelect.value;
            const addDV = getElement('dental-vision').value === 'yes';
            const mmAmount = getElement('major-medical-amount').value;
            const frequency = getElement('payment-frequency').value;

            // 1. Get Base Plan Premium
            let baseRateSet = {annual:0, semi:0, quarterly:0};
            if (planType !== 'mm_only') {
                let baseRateKey = familyStatus;
                if (familyStatus === 'single_female' || familyStatus === 'husband_wife') {
                    baseRateKey += (maternity === 'yes') ? '_with_maternity' : '_no_maternity';
                }
                baseRateSet = RATES.base.standard[baseRateKey]?.[ageBand]?.[childrenCount] || {annual:0, semi:0, quarterly:0};
            }

            // 2. Get Vision & Dental Premium (new logic)
            let vdRateSet = {annual:0, semi:0, quarterly:0};
            if (planType !== 'mm_only' && addDV) {
                let vdFamilyKey = familyStatus;
                 if (familyStatus === 'single_female_no_maternity' || familyStatus === 'single_female_with_maternity') {
                    vdFamilyKey = 'single_female';
                } else if (familyStatus === 'husband_wife_no_maternity' || familyStatus === 'husband_wife_with_maternity') {
                    vdFamilyKey = 'husband_wife';
                }
                vdRateSet = RATES.vision_dental[vdFamilyKey]?.[childrenCount] || {annual:0, semi:0, quarterly:0};
            }
            
            // 3. Get Major Medical Premium
            let mmRateSet = {annual:0, semi:0, quarterly:0};
            if (planType !== 'base_only') {
                let mmRateKey = familyStatus;
                if (familyStatus.startsWith('single_female')) mmRateKey = 'single_female';
                const mmChildrenKey = (childrenCount === '0') ? '0' : '1+';
                mmRateSet = RATES.major_medical[mmAmount]?.[mmRateKey]?.[ageBand]?.[mmChildrenKey] || {annual:0, semi:0, quarterly:0};
            }

            // 4. Sum up premiums for the selected frequency
            const basePremium = baseRateSet[frequency] || 0;
            const vdPremium = vdRateSet[frequency] || 0;
            const mmPremium = mmRateSet[frequency] || 0;
            
            const subTotal = basePremium + vdPremium + mmPremium;
            const totalPremium = subTotal; // In case of future taxes/fees
            
            // 5. Display Main Results
            const frequencyLabel = frequency.charAt(0).toUpperCase() + frequency.slice(1);
            getElement('total-premium').textContent = formatCurrency(totalPremium);
            getElement('total-premium-label').textContent = `(Total ${frequencyLabel} Premium)`;
            
            let breakdownHTML = '';
            if (planType !== 'mm_only') {
                 let baseLabel = "COVERCARE Base Premium";
                 if (familyStatus === 'single_female' || familyStatus === 'husband_wife') {
                    const hasMaternity = maternity === 'yes' && !maternitySelect.disabled;
                    baseLabel += hasMaternity ? " (w/ Maternity)" : " (No Maternity)";
                 }
                 breakdownHTML += `<p class="breakdown-row"><span>${baseLabel}:</span> <strong>${formatCurrency(basePremium)}</strong></p>`;
            }
            if (vdPremium > 0) breakdownHTML += `<p class="breakdown-row"><span>+ Vision & Dental Benefit:</span> <strong>${formatCurrency(vdPremium)}</strong></p>`;
            if (planType !== 'base_only') breakdownHTML += `<p class="breakdown-row"><span>+ Major Medical:</span> <strong>${formatCurrency(mmPremium)}</strong></p>`;
            
            if (subTotal > 0 && (vdPremium > 0 || mmPremium > 0)) {
                breakdownHTML += `<p class="breakdown-row font-semibold border-t border-dashed border-[var(--border-color)] pt-1 mt-1"><span>Sub-Total:</span> <strong>${formatCurrency(subTotal)}</strong></p>`;
            }

            breakdownHTML += `<p class="breakdown-row font-bold text-lg border-t-2 border-[var(--primary-accent)] pt-2 mt-2"><span>Total ${frequencyLabel} Premium:</span> <strong>${formatCurrency(totalPremium)}</strong></p>`;
            getElement('premium-breakdown').innerHTML = breakdownHTML;
            
            // 6. Display Frequency Comparison
            let comparisonHTML = `<h4 class="font-bold text-md text-[var(--text-primary)]">Payment Options</h4><table class="w-full mt-2 text-xs"><thead><tr class="text-left"><th class="font-semibold pb-1">Frequency</th><th class="font-semibold pb-1 text-right">Premium</th><th class="font-semibold pb-1 text-right">Saving vs. Annual</th></tr></thead><tbody>`;
            const annualTotal = (baseRateSet.annual || 0) + (vdRateSet.annual || 0) + (mmRateSet.annual || 0);
            ['annual', 'semi', 'quarterly'].forEach(freq => {
                const freqPremium = (baseRateSet[freq] || 0) + (vdRateSet[freq] || 0) + (mmRateSet[freq] || 0);
                const multiplier = { annual: 1, semi: 2, quarterly: 4}[freq];
                const effectiveAnnualCost = freqPremium * multiplier;
                const saving = annualTotal - effectiveAnnualCost;
                const isSelected = freq === frequency ? 'font-bold text-[var(--primary-accent)]' : '';
                comparisonHTML += `<tr class="${isSelected}"><td>${freq.charAt(0).toUpperCase() + freq.slice(1)}</td><td class="text-right">${formatCurrency(freqPremium)}</td><td class="text-right">${formatCurrency(saving)}</td></tr>`;
            });
            comparisonHTML += `</tbody></table>`;
            getElement('frequency-comparison').innerHTML = comparisonHTML;

            // 7. Calculate Finder's Fee
            const feeBasePremium = basePremium + vdPremium + mmPremium;
            const findersFee = calculateAndDisplayFindersFee(feeBasePremium);
            
            // 8. Store data for referral submission
            lastCalculatedData = {
                insuranceType: 'Health',
                totalPremium,
                basePremium,
                vdPremium,
                mmPremium,
                findersFee,
                premiumFrequency: frequency
            };
        }

        function calculateAndDisplayFindersFee(premium) {
            const feeSection = getElement('finders-fee-section');
            if (!currentUserData || currentUserData.waivesAllFees || premium <= 0) { 
                feeSection.classList.add('hidden'); 
                return 0;
            }
            const commissionSplit = (currentUserData.commissionSplit || 50) / 100;

            const totalCommission = premium * 0.25;
            const incomeTax = totalCommission * 0.25;
            const netCommission = totalCommission - incomeTax;
            const fee = netCommission * commissionSplit;
            
            getElement('finders-fee-breakdown').innerHTML = `
                <div class="breakdown-row"><span>Premium for Fee Calc.</span><span class="font-semibold">${formatCurrency(premium)}</span></div>
                <div class="breakdown-row mt-2"><span>Total Commission (25%)</span><span class="font-semibold">${formatCurrency(totalCommission)}</span></div>
                <div class="breakdown-row text-red-600"><span>- Income Tax (25%)</span><span>-${formatCurrency(incomeTax)}</span></div>
                <div class="breakdown-row font-semibold border-t pt-1 mt-1"><span>Net Commission Payable</span><span>${formatCurrency(netCommission)}</span></div>
                <div class="breakdown-row text-green-600 mt-2"><span class="font-bold">Your Finder's Fee (${commissionSplit*100}%)</span><span class="font-bold">${formatCurrency(fee)}</span></div>
            `;
            feeSection.classList.remove('hidden');
            return fee;
        }
        
        function generateFinalQuoteText() {
            const getSelectedText = (id) => getElement(id).options[getElement(id).selectedIndex].text;
            let quoteDetails = `
Plan Type:          ${getSelectedText('plan-type')}
Family Status:      ${getSelectedText('family-status')}
Age Band:           ${getSelectedText('age-band')}
Number of Children: ${getSelectedText('children-count')}
`;
            if (getElement('plan-type').value !== 'mm_only') {
                const maternitySelect = getElement('maternity');
                const maternityStatus = maternitySelect.disabled ? 'N/A' : getSelectedText('maternity');
                quoteDetails += `Dental & Vision:    ${getSelectedText('dental-vision')}\nMaternity Included: ${maternityStatus}\n`;
            }
            if (getElement('plan-type').value !== 'base_only') {
                 quoteDetails += `MM Coverage:        ${getSelectedText('major-medical-amount')}\n`;
            }
            const breakdownText = getElement('premium-breakdown').innerText;
            const comparisonText = getElement('frequency-comparison').innerText.replace('Payment Options', '\nPAYMENT OPTIONS:\n--------------');
            fullQuoteText = `=========================================\n    OFFICIAL COVERCARE INSURANCE QUOTATION\n=========================================\nDate: ${new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}\n\nCLIENT & PLAN DETAILS:\n----------------------\n${quoteDetails.trim()}\n\nPREMIUM SUMMARY:\n-----------------\n${breakdownText}\n\n${comparisonText}\n=========================================\n\nThis quotation is valid for 30 days.\nTerms and conditions apply.`;
            getElement('quote-output').textContent = fullQuoteText.trim();
        }

        function generateAndDownloadPDF() {
            const clientName = getElement('client-name').value || 'Valued Client';
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const drawPage = (doc) => {
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(24);
                doc.setTextColor('#005f73');
                doc.text('TATIL', 14, 20);
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(10);
                doc.setTextColor('#1d2d35');
                doc.text('TATIL Building, 11 Maraval Road, Port of Spain', 14, 28);

                doc.setFontSize(18);
                doc.setTextColor('#ae8625');
                doc.text('COVERCARE Health Insurance Quotation', 200, 24, { align: 'right' });
                
                doc.setDrawColor('#dce1e7');
                doc.line(14, 35, 200, 35);

                let yPos = 45;
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text('Date:', 14, yPos);
                doc.setFont('helvetica', 'normal');
                doc.text(new Date().toLocaleDateString('en-GB', { day: '2-digit', month: 'long', year: 'numeric' }), 35, yPos);
                
                doc.setFont('helvetica', 'bold');
                doc.text('Prepared For:', 14, yPos + 7);
                doc.setFont('helvetica', 'normal');
                doc.text(clientName, 42, yPos + 7);

                yPos += 20;

                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor('#005f73');
                doc.text('Selected Plan Details', 14, yPos);
                doc.setDrawColor('#dce1e7');
                doc.line(14, yPos + 2, 200, yPos + 2);
                yPos += 10;
                
                const getSelectedText = (id) => getElement(id).options[getElement(id).selectedIndex].text;
                const planDetails = [];
                planDetails.push(['Plan Type:', getSelectedText('plan-type')]);
                planDetails.push(['Family Status:', getSelectedText('family-status')]);
                planDetails.push(['Age Band:', getSelectedText('age-band')]);
                planDetails.push(['Number of Children:', getSelectedText('children-count')]);

                if (getElement('plan-type').value !== 'mm_only') {
                    const maternitySelect = getElement('maternity');
                    const maternityStatus = maternitySelect.disabled ? 'N/A' : getSelectedText('maternity');
                    planDetails.push(['Dental & Vision:', getSelectedText('dental-vision')]);
                    planDetails.push(['Maternity Included:', maternityStatus]);
                }
                 if (getElement('plan-type').value !== 'base_only') {
                    planDetails.push(['Major Medical Coverage:', getSelectedText('major-medical-amount')]);
                }

                doc.setFontSize(10);
                doc.setTextColor('#1d2d35');
                planDetails.forEach(detail => {
                    doc.setFont('helvetica', 'bold');
                    doc.text(detail[0], 16, yPos);
                    doc.setFont('helvetica', 'normal');
                    doc.text(detail[1], 60, yPos);
                    yPos += 7;
                });
                yPos += 5;

                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor('#005f73');
                doc.text('Premium Summary', 14, yPos);
                doc.line(14, yPos + 2, 200, yPos + 2);
                yPos += 10;

                doc.setFillColor('#f4f6f9');
                doc.rect(14, yPos - 2, 186, 8, 'F');
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text('Benefit Description', 16, yPos + 4);
                doc.text('Premium', 198, yPos + 4, { align: 'right' });
                yPos += 10;

                doc.setFont('helvetica', 'normal');
                const breakdownRows = Array.from(getElement('premium-breakdown').querySelectorAll('.breakdown-row'));
                breakdownRows.forEach(row => {
                    const label = row.children[0].textContent;
                    const value = row.children[1].textContent;
                    if (label.toLowerCase().includes('total')) {
                        doc.setFont('helvetica', 'bold');
                        doc.setDrawColor('#dce1e7');
                        doc.line(14, yPos - 2, 200, yPos - 2);
                    }
                    doc.text(label, 16, yPos);
                    doc.text(value, 198, yPos, { align: 'right' });
                    yPos += 7;
                     if (label.toLowerCase().includes('total')) {
                        doc.setFont('helvetica', 'normal');
                    }
                });
                
                doc.setFontSize(8);
                doc.setTextColor('#718096');
                doc.text('This is an unofficial quotation and is valid for 30 days. All premiums are in USD. Terms and conditions apply.', 105, 285, { align: 'center' });
                doc.text('Generated by the TATIL Referral Hub.', 105, 290, { align: 'center' });
            };

            drawPage(doc);
            doc.save(`COVERCARE_Quote_for_${clientName.replace(/\s/g, '_')}.pdf`);
        }

        async function submitReferral() {
            const clientName = getElement('client-name').value, clientEmail = getElement('client-email').value, clientContact = getElement('client-contact').value;
            const errorEl = getElement('client-modal-error');
            if (!clientName || !clientEmail || !clientContact) {
                errorEl.textContent = "Please fill out all client fields."; return;
            }
            errorEl.textContent = "";

            const submitBtn = getElement('submit-referral-btn');
            submitBtn.innerHTML = '<span class="loader !w-6 !h-6 !border-white/50 !border-b-transparent"></span>';
            submitBtn.disabled = true;

            const feeWaived = getElement('waive-fee-checkbox').checked;
            const getSelectedText = (id) => getElement(id).options[getElement(id).selectedIndex].text;
            const planType = getElement('plan-type').value;
            const maternitySelect = getElement('maternity');
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            
            const submissionData = {
                ...lastCalculatedData,
                feeWaived,
                findersFee: feeWaived ? 0 : lastCalculatedData.findersFee,
                commissionSplitAtTimeOfReferral: currentUserData.commissionSplit || 50,
                planType: getSelectedText('plan-type'),
                familyStatusText: getSelectedText('family-status'),
                ageBand: getSelectedText('age-band'),
                childrenCountText: getSelectedText('children-count'),
                premiumFrequency: getSelectedText('payment-frequency'),
                dentalVisionAdded: getElement('dental-vision').value === 'yes',
                maternity: (planType !== 'mm_only' && !maternitySelect.disabled) ? getSelectedText('maternity') : 'N/A',
                mmAmount: planType !== 'base_only' ? getSelectedText('major-medical-amount') : 'N/A',
                clientName, clientEmail, clientContact,
            };

            try {
                if (editMode) {
                    const referralRef = doc(db, "artifacts", appId, "public/data/referrals", referralIdToEdit);
                    await updateDoc(referralRef, {
                        ...submissionData,
                        status: 'Resubmitted',
                        lastUpdatedAt: Timestamp.now()
                    });
                } else {
                    await addDoc(collection(db, "artifacts", appId, "public/data/referrals"), {
                        ...submissionData,
                        referrerId: auth.currentUser.uid,
                        referrerName: currentUserData.name || 'N/A',
                        status: 'Pending',
                        createdAt: Timestamp.now()
                    });
                }
                getElement('quote-referral-modal').style.display = 'none';
                getElement('success-modal').style.display = 'flex';
            } catch (error) {
                console.error("Error submitting referral: ", error);
                errorEl.textContent = "Could not submit referral. Please try again.";
            } finally {
                submitBtn.innerHTML = editMode ? 'Update Referral' : 'Submit Referral';
                submitBtn.disabled = false;
            }
        }
    </script>
    <script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js')
                .then(registration => {
                    console.log('Service Worker registered with scope:', registration.scope);
                })
                .catch(err => {
                    console.log('Service Worker registration failed:', err);
                });
        });
    }
</script>
</body>
</html>
